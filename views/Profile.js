"use strict";ComApp.Store.Profile=function(e){var t,a,n,i,o,s=$.Deferred(),r=!1,d=ko.observable(!1),l=ko.observable(""),c=ko.observable(""),u={newlistEditor:'<div><div class="input"><input type="text" placeholder="'+gbM("require")+'" class="sodienthoai dx-texteditor-input"/></div><div class="dx-invalid-message dx-overlay"><div class="dx-overlay-wrapper dx-invalid-message"style="z-index: 1501; position: absolute;text-align: right;padding-right: 20px;"><div class="dx-overlay-content dx-resizable" style="width: auto; height: auto; z-index: 1501; margin: 0px; left: 0px; top: 0px; transform: translate(-1px, 1px); transition: all 0s ease 0s; max-width: 468px;">'+gbM("require")+"</div></div></div></div>"},p=ko.observable(!1),f=!0,v=function(e){if("1"!=clickPrevent){clickLocked(),nutclickeffect($(e.target));var t=$(e.target).closest(".ordersrow"),a=t.find(".listcol-tg");if(t.hasClass("rowediting"))a.find(".suarow").fadeOut("fast",function(){$(this).remove(),t.removeClass("rowediting")});else DevExpress.ui.dialog.confirm('<div style="text-align:center;max-width:300px"><i class="fa fa-question-circle" style="padding:10px"></i>'+gbM("confirmdel")+"</div>","Confirm changes").done(function(e){e&&(scrLocked(),t.fadeOut("fast",function(){var e=t.parent();$(this).remove(),b(e,void 0,function(e){x(["phone","name","addr"],e)})}))})}},m=function(e,t,a){for(var n=0;n<e.length;n++){if($.trim(e[n]).length>0){var i=u.orderR.clone(),o="";a&&(i.addClass("defitem"),o='class="defitem"'),i.find(".listcol-tg").append("<span "+o+">"+e[n]+"</span>"),i.find(".delrow").bind("click",function(e){v(e)}),i.find(".stt").text(t.find(".ordersrow").length+1+"/ "),t.append(i)}}},g=function(e,t){var a=function(e){if(e.hasClass("sodienthoai")){var t=e.parent(),a=t.parent();t.hasClass("txt-invalid")&&""!=$.trim(e.val())&&(t.removeClass("txt-invalid"),a.removeClass("errdulieu"))}};e.attr("type",t),e.blur(function(){a($(this)),$(this).parent().parent().removeClass("dx-state-focused")}).focus(function(){$(this).parent().parent().addClass("dx-state-focused")}).keypress(function(e){var n=e.keyCode||e.which;if("13"==n);else if("tel"==t&&"tel"==this.type&&8!=n&&0!=n&&(n<48||n>57))return!1;a($(this))})},x=function(e,t){$.each(e,function(e,a){u[a].empty(),m([t.data[a]],u[a],!0),m(t.exdata[a],u[a],!1)})},h=function(e){var t={UserName:o.exdata.UserName,Email:o.exdata.Email,Gender:o.exdata.Gender};if(""!=o.exdata.imgURL?c(o.exdata.imgURL):c("../images/useravatar.png"),f=!0,null==a){(a=e.find(".frmUserInfor").dxForm({formData:t,onFieldDataChanged:function(e){var t=e.dataField,a=(e.value,e.component.getEditor(t));if(a){var n='style="margin-top: -2px;margin-left: 32px;"';"Gender"!=t&&(n="");var i=a._$element.find("input").parent(),o=$("<span "+n+' name="'+t+'" class="ahieuungclick dx-icon-revert"></span>');f?(i.removeClass("fieldvalchanged"),i.find("span.dx-icon-revert").remove(),p(!1)):i.hasClass("fieldvalchanged")||(i.addClass("fieldvalchanged"),i.append(o),p(!0))}},items:[{itemType:"group",caption:gbM("userinfo"),items:[{dataField:"UserName",label:{text:gbM("username")}},{dataField:"Gender",label:{text:gbM("gender")},editorType:"dxRadioGroup",editorOptions:{layout:"horizontal",dataSource:[{text:gbM("male"),value:"1"},{text:gbM("female"),value:"0"}],displayExpr:"text",valueExpr:"value"}},{dataField:"Email",validationRules:[{type:"email",message:"Invalid email."}]}]}]}).dxForm("instance"))._$element.on("click","span.dx-icon-revert",function(e){if("1"!=clickPrevent){clickLocked();var t=$(e.target);nutclickeffect(t),t.fadeOut("slow",function(){t.parent().removeClass("fieldvalchanged"),t.remove(),p(a._$element.find(".fieldvalchanged").length>0)}),a.updateData(t.attr("name"),o.exdata[t.attr("name")])}}),e.find(".lsthieu").each(function(e,t){0==e?(u.phone=$(t),u.orderR=u.phone.find(".ordersrow"),u.orderR.detach(),u.suarow=u.orderR.find(".suarow"),u.suarow.detach(),m([o.data.phone],u.phone,!0),m(o.exdata.phone,u.phone,!1)):1==e?(u.name=$(t),m([o.data.name],u.name,!0),m(o.exdata.name,u.name,!1)):2==e&&(u.addr=$(t),m([o.data.addr],u.addr,!0),m(o.exdata.addr,u.addr,!1))});var n=function(e){$(e[0]).children().first().fadeOut("fast",function(){$(e[0]).removeClass("dx-texteditor"),$(e[1]).css("display","none");var t=$(e[2]).data("dxButton");t.option({icon:"plus",type:"normal"}),t.cpInput=void 0,$(this).remove()})};e.on("click",".canceladd",function(e,t){var a=$(e.target);if(null==t){if("1"==clickPrevent)return;clickLocked(),nutclickeffect(a)}n(a.parent().children())}).on("click",".editrow",function(e){if("1"!=clickPrevent){clickLocked(),nutclickeffect($(e.target));var t=$(e.target).closest(".ordersrow"),a=t.find(".listcol-tg");if(t.hasClass("rowediting")){var i=a.find("input"),o=""!=$.trim(i.val());if(!o||!k(t.parent(),$.trim(i.val()),parseInt(t.find(".stt").text()))){var s=i.parent(),r=s.parent(),d="";s.addClass("txt-invalid"),r.addClass("errdulieu"),d=o?gbM("dupinfo"):gbM("require"),r.find(".dx-overlay-content").text(d),o=!1,setTimeout(function(){i.focus(),i.select()},300)}o&&(n(i.closest("lsthieu-additem").children().first()),a.find("span").text($.trim(i.val())),b(t.parent(),void 0,function(e){x(["phone","name","addr"],e)}))}else{t.addClass("rowediting");var l=u.suarow.clone(),c=l.find("input");a.append(l),g(c,"phone"==t.parent().attr("name")?"tel":"text"),c.val(a.find("span").text())}}})}else x(["phone","name","addr"],o),a.option("formData",t);f=!1},b=function(e,t,a){var n="",i=[],o=function(e,t){_$q.next(!1),"err"==t||a&&a(e),scrReleased()};e.find(".listcol-tg span").each(function(e,t){$(t).hasClass("defitem")?n=$(t).text():i.push($(t).text())}),null!=t&&i.push(t),scrLocked(),_$q.add(function(){_$a.api("POST","634445598610781250052977",{act:"savelist",kind:"mod"+e.attr("name"),data:[n,i],uid:buttonlogout.cptmp},function(e){o(e,"ok"),C([e.data,e.exdata])},function(e){o(e,"err")})},!0)},k=function(e,t,a){var n=!0;return e.find(".listcol-tg span").each(function(e,i){if($.trim($(i).text())==$.trim(t)){if(!(a>0))return n=!1,!1;var o=parseInt($(i).closest(".ordersrow").find(".stt").text());if(a!=o)return n=!1,!1}}),n},C=function(e){localDB.exe("add","exUI",e,0)},y=function(e){u.loginsec.removeClass("changematkhau"),d(e),l(gbM("S0_012").toUpperCase()),i&&(i.dispose(),i=null),n&&n.remove()},w=function(){if(lgmk.length>0){for(var e=lgmk.split(String.fromCharCode(36)),a=u.loginsec.find("input"),n=0;n<a.length;n++)a[n].value=e[n];t.html("<div>"+gbM("defacc")+"</div>"),t.parent().removeClass("fail").addClass("info")}else t.empty(),t.parent().removeClass("fail").removeClass("info")},_={modelIsReady:s.promise(),slideMenu:function(e){},logout:function(e){y(!1),l(gbM("S1_015")),d(!1),t.parent().removeClass("fail").removeClass("info"),w()},changepass:function(e){u.loginsec.addClass("changematkhau"),function(e){var t="";if(lgmk.length>0){var a=lgmk.split(String.fromCharCode(36));buttonlogout.cptmp&&buttonlogout.cptmp==a[2]&&(t=a[1])}n=$("<div style='max-width:450px;margin:auto;padding:20px'/>");var o,s,r=null,c=function(){null!=r&&(r.remove(),o.data("dxButton").option({disabled:!1}),r=null)};i=n.appendTo(u.loginsec).dxForm({showColonAfterLabel:!0,labelLocation:"top",onFieldDataChanged:function(e){c()},items:[{dataField:"oldpass",label:{text:gbM("oldpass")},editorOptions:{mode:"password",disabled:""!=t,value:t},validationRules:[{type:"required",message:gbM("require")},{type:"custom",validationCallback:function(e){return s=e,!0}}]},{itemType:"group",caption:gbM("newpass").toUpperCase(),horizontalAlignment:"center",items:[{dataField:"newpass",label:{text:gbM("newpass")},editorOptions:{mode:"password"},validationRules:[{type:"required",message:gbM("require")}]},{label:{text:gbM("renewpass")},editorType:"dxTextBox",editorOptions:{mode:"password"},validationRules:[{type:"required",message:gbM("require")},{type:"compare",message:gbM("notmatchpass"),comparisonTarget:function(){return i.option("formData").newpass}}]}]},{template:function(e,t){var a=$('<div style="text-align:center"/>').appendTo(t);return o=$("<div>").dxButton({text:gbM("S1_024"),type:"success",useSubmitBehavior:!0,onClick:function(e){c(),i.validate().isValid&&setTimeout(function(){DevExpress.ui.dialog.confirm('<div style="text-align:center;max-width:300px"><i class="fa fa-question-circle" style="padding:10px"></i>'+gbM("confirmation")+"</div>","Confirm changes").done(function(e){if(e){scrLocked();var t=function(e,t){_$q.next(!1);var a=function(){if(s){var e=s.validator._validationRules[1];e.isValid=!1,e.message=gbM("wrongpass"),s.validator.validate()}o.data("dxButton").option({disabled:!0})};if("ok"==e){var i=JSON.parse(t.msg);i.hasOwnProperty(t.kq)?(r=$("<div class='dathang' style='margin-bottom:0px;display:block'><div class='login screen-dangnhap fail'><div class='feedback'><span class='fa fa-exclamation-triangle'></span><div>"+i[t.kq]+"</div></div></div></div>"),n.append(r),t.kq<=0&&a()):confirmDlg(i.ok,[0],function(){lgmk="",localDB.exe("rmv","lgmk",null,2),y(!0)})}else a();scrReleased()};_$q.add(function(){_$a.api("POST","634445598610781250052977",{act:"savelist",kind:"changepass",uid:buttonlogout.cptmp,data:i.option("formData")},function(e){t("ok",e)},function(e){t("err",e)})},!0)}})},200)}}).appendTo(a).css({"margin-right":"10px"}),$("<div>").dxButton({text:gbM("S1_025"),onClick:function(e){y(!0)}}).appendTo(a),t}}]}).dxForm("instance"),d(!1),l(gbM("changepass"))}()},title:l,viewShowing:function(e){"user"==buttonlogout()?i||(d(!0),l(gbM("S0_012").toUpperCase())):(d(!1),l(gbM("S1_015").toUpperCase()),u.hasOwnProperty("loginsec")&&(y(!1),w()))},save_action:function(e,t){if("1"!=clickPrevent){clickLocked();var n=$(t.target).parent();nutclickeffect(n);var i=a.validate();i.isValid?setTimeout(function(){DevExpress.ui.dialog.confirm('<div style="text-align:center;max-width:300px"><i class="fa fa-question-circle" style="padding:10px"></i>'+gbM("confirmation")+"</div>","Confirm changes").done(function(e){e&&(scrLocked(),a._$element.find(".fieldvalchanged").removeClass("fieldvalchanged").find("span.dx-icon-revert").remove(),p(!1),_$q.add(function(){_$a.api("POST","634445598610781250052977",{act:"savelist",kind:"userinfo",uid:buttonlogout.cptmp,data:a.option("formData")},function(e){_$q.next(!1),C([e.data,e.exdata]),scrReleased()},function(e){_$q.next(!1),scrReleased()})},!0))})},200):confirmDlg(i.brokenRules[0].message+" "+i.brokenRules[0].value,[0],function(){})}},newlistItem:function(e){if(null==e.component.cpInput){e.component.option({icon:"save",type:"success"});var t=$(u.newlistEditor),a=e.element.closest(".lsthieu-additem");a.children().first().append(t).addClass("dx-texteditor"),a.find(".canceladd").css("display","block"),e.component.cpInput=t.find("input"),g(e.component.cpInput,"phone"==this?"tel":"text")}else{var n=e.component.cpInput,i=$.trim(n.val()),o=""!=i;if(!o||!k(e.component._$element.closest(".lsthieu-additem").prev(),i,0)){var s=n.parent(),r=s.parent(),d="";s.addClass("txt-invalid"),r.addClass("errdulieu"),d=o?gbM("dupinfo"):gbM("require"),r.find(".dx-overlay-content").text(d),o=!1,setTimeout(function(){n.focus(),n.select()},200)}o&&(e.element.closest(".lsthieu-additem").find(".canceladd").trigger("click",{causeby:"1"}),b(e.component._$element.closest(".lsthieu-additem").prev(),i,function(e){x(["phone","name","addr"],e)}))}},userinfo:d,bindinput:function(e){var a;r||(u.loginsec=e.element.closest(".view-content.profile").prev(),a=u.loginsec.find("input"),t=u.loginsec.find(".feedback"),r=!0,a.blur(function(){var e=$(this);if(e.hasClass("sodienthoai")){var t=e.parent(),a=t.parent();t.hasClass("txt-invalid")&&""!=$.trim(e.val())&&(t.removeClass("txt-invalid"),a.removeClass("errdulieu"))}$(this).parent().parent().removeClass("dx-state-focused")}).focus(function(){$(this).parent().parent().addClass("dx-state-focused")}).keypress(function(e){var t=e.keyCode||e.which;if("13"==t){if("1"==clickPrevent)return;clickLocked(),u.loginsec.find(".dangnhap_button").trigger("click",{causeby:"1"})}else if("tel"==this.type&&8!=t&&0!=t&&(t<48||t>57))return!1}).keydown(function(e){t.parent().removeClass("fail").removeClass("info")}),u.loginsec.on("click",".dangnhap_button",function(e,a){if(null==a){if("1"==clickPrevent)return;clickLocked()}var n=u.loginsec.find("input");global_login(n,t,function(e){var t=JSON.parse(e.msg);$.extend(t,e.data),l(gbM("S0_012").toUpperCase()),o=e,h(u.loginsec.closest(".dx-scrollview-content")),quanlyorderlogin(t.uid,t.MatchRst),d(!0)})}),"user"==buttonlogout()?h(e.element.closest(".dx-scrollview-content")):u.hasOwnProperty("loginsec")&&w())},userphoto:c,isEditProfile:p,photoeditor:function(e){var t="../photoeditor/index.htm?isDevice="+mobileClient+"&w=200&h=200&bagid=1&"+JsCssPrefix.replace("?",""),a=$('<div class="iframe-wrapper" style="z-index:200"><iframe scrolling="no" src="'+t+'"></iframe></div>');a.find("iframe").on("load",function(){this.contentWindow.startEditor({act:"-1"},function(e){switch(e.act){case"exit":a.remove();break;case"srcLocked":scrLocked(e.delay);break;case"save":a.remove(),_$q.add(function(){_$a.api("POST","634445598610781250052977",{act:"savelist",kind:"userimg",uid:buttonlogout.cptmp,imgURL:e.imgurLink},function(t){_$q.next(!1),c(e.imgBase64),C([t.data,t.exdata]),scrReleased()},function(e){_$q.next(!1),scrReleased()})},!0)}})}),a.appendTo(".dx-viewport")}};if(!r)if("user"==buttonlogout()){d(!0);var M=function(e,t){_$q.next(!1),"ok"==t&&(o=e,s.resolve())};_$q.add(function(){_$a.api("POST","634445598610781250052977",{act:"savelist",kind:"logininfo",uid:buttonlogout.cptmp},function(e){M(e,"ok"),C([e.data,e.exdata])},function(e){M(e,"err")})},!0)}else s.resolve();return _};